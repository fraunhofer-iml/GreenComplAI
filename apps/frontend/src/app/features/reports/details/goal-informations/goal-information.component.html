<div class="flex w-full flex-col gap-2">
  @if (goalsForm.controls.goals.length === 0) {
    <div
      class="bg-primary-800/30 flex w-full flex-row items-center gap-2 rounded-lg p-4"
    >
      <span class="material-symbols-outlined">error</span>
      <span>
        Es wurden noch keine Ziele hinzugefügt! Wenn es keine Ziele gibt, sind
        die folgenden weiteren Angaben erforderlich.</span
      >
    </div>
    <div
      class="flex w-full flex-row gap-2 rounded-lg bg-neutral-200 p-4"
      [formGroup]="goalPlanningForm"
    >
      <div class="flex w-full flex-col gap-4">
        <div class="flex w-full flex-col gap-2">
          <section class="">
            <mat-radio-group
              [required]="
                goalPlanningForm.controls.goalsPlanned.hasValidator(
                  Validators.required
                )
              "
              formControlName="goalsPlanned"
              class="flex flex-row items-center gap-4"
            >
              <mat-label i18n>Wurden bereits Ziele geplant?</mat-label>
              <mat-radio-button [value]="true" i18n>Ja</mat-radio-button>
              <mat-radio-button [value]="false" i18n>Nein</mat-radio-button>
            </mat-radio-group>
            @if (goalPlanningForm.controls.goalsPlanned.hasError('required')) {
              <mat-error class="text-sm">Angabe erforderlich. </mat-error>
            }
          </section>
          @if (goalPlanningForm.controls.goalsPlanned.value === true) {
            <app-date-picker-month-year
              [form]="goalPlanningForm.controls.deadline"
              [disabled]="report().isFinalReport"
              class="flex h-full w-full gap-2"
            >
              <mat-label>Frist</mat-label></app-date-picker-month-year
            >
          }
          @if (goalPlanningForm.controls.goalsPlanned.value === false) {
            <mat-form-field appearance="outline">
              <mat-label i18n>Begründung</mat-label>
              <textarea
                matInput
                [readonly]="report().isFinalReport"
                formControlName="noGoalsExplanation"
                placeholder="Warum wurden keine Ziele geplant?"
              ></textarea>
            </mat-form-field>
          }

          <section>
            <mat-checkbox #goalstracked formControlName="goalsTracked"
              >Wirksamkeit der Strategien und Ziele werden
              nachverfolgt</mat-checkbox
            >
          </section>

          @if (goalstracked.checked) {
            <mat-form-field appearance="outline">
              <mat-label i18n
                >Welche verfahren zur Nachverfolgung werden genutzt?</mat-label
              >
              <textarea
                matInput
                cdkTextareaAutosize
                #autosize="cdkTextareaAutosize"
                cdkAutosizeMinRows="1"
                [readonly]="report().isFinalReport"
                formControlName="followUpProcedure"
                placeholder="Welche verfahren zur Nachverfolgung werden genutzt"
              ></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label i18n>Welche Zielvorgaben existieren?</mat-label>
              <textarea
                matInput
                cdkTextareaAutosize
                #autosize="cdkTextareaAutosize"
                cdkAutosizeMinRows="1"
                [readonly]="report().isFinalReport"
                formControlName="targets"
                placeholder="Zielvorgaben"
              ></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label i18n
                >qualitative oder quantitative Indikatoren der
                Fortschrittsbewertung</mat-label
              >
              <textarea
                matInput
                cdkTextareaAutosize
                #autosize="cdkTextareaAutosize"
                cdkAutosizeMinRows="1"
                [readonly]="report().isFinalReport"
                formControlName="progression"
                placeholder="Indikatoren der Fortschrittsbewertung"
              ></textarea>
            </mat-form-field>

            <app-date-picker-month-year
              [form]="goalPlanningForm.controls.referencePeriodForProgression"
              [disabled]="report().isFinalReport"
              class="flex h-full w-full gap-2"
            >
              <mat-label>Bezugszeitraum der Fortschrittsmessung</mat-label>
            </app-date-picker-month-year>
          }
        </div>
      </div>
    </div>
  }

  @if (goalsForm.controls.goals.length !== 0) {
    <div [formGroup]="goalsForm">
      <mat-tab-group
        formArrayName="goals"
        class="w-full"
        [selectedIndex]="selectedTabIndex"
        (selectedIndexChange)="selectedTabIndex = $event"
      >
        @for (
          goal of goalsForm.controls.goals.controls;
          track goal;
          let pindex = $index
        ) {
          <mat-tab [formGroupName]="pindex" label="Ziel">
            <ng-template mat-tab-label>
              <span
                matBadge="!"
                matBadgeSize="small"
                [matBadgeHidden]="goal.valid"
                matBadgeOverlap="false"
                >{{
                  goalsForm.controls.goals.value[pindex].title ?? 'Neues Ziel'
                }}</span
              >
            </ng-template>
            <div class="grid grid-cols-2">
              <app-goals
                class="col-span-2"
                (removeEvent)="removeGoal(pindex)"
                [isFinal]="report().isFinalReport"
                [form]="goal"
              ></app-goals>
            </div>
          </mat-tab>
        }
      </mat-tab-group>
    </div>
  }
  @if (!report().isFinalReport) {
    <div class="flex justify-between gap-2">
      @if (!report().isFinalReport) {
        <button mat-flat-button (click)="addGoal()">
          <mat-icon>add</mat-icon>
          Ziel hinzufügen
        </button>
      }
      <button
        mat-flat-button
        (click)="save()"
        i18n
        [disabled]="
          goalsForm.controls.goals.length === 0
            ? goalPlanningForm.invalid
            : goalsForm.invalid
        "
      >
        <mat-icon>save</mat-icon>
        Speichern
      </button>
    </div>
  }
</div>
