<div class="w-full">
  <div class="flex flex-col gap-2" [formGroup]="form">
    @if (this.form.controls.goals.controls.length === 0) {
      <div
        class="hover:border-primary-700 group col-span-2 flex w-full flex-row gap-2 rounded-lg border-[1px] border-solid border-transparent bg-neutral-200 p-4"
      >
        <div class="flex w-full flex-col gap-4">
          Es wurden noch keine Ziele hinzugefügt.

          <div class="flex w-full flex-col">
            <div>
              <section class="m-2 grid w-full gap-2">
                <mat-radio-group
                  formControlName="goalsPlanned"
                  class="flex flex-row gap-4"
                >
                  <mat-label i18n>Wurden bereits Ziele geplant?</mat-label>
                  <mat-radio-button value="true" i18n>Ja</mat-radio-button>
                  <mat-radio-button value="false" i18n>Nein</mat-radio-button>
                </mat-radio-group>
              </section>
              @if (form.controls.goalsPlanned.value === 'true') {
                <mat-form-field appearance="outline" class="m-2 w-full">
                  <mat-label>Frist</mat-label>
                  <mat-date-range-input
                    [formGroup]="form.controls.validDate"
                    [rangePicker]="picker"
                  >
                    <input
                      matStartDate
                      formControlName="from"
                      placeholder="Start date"
                    />
                    <input
                      matEndDate
                      formControlName="to"
                      placeholder="End date"
                    />
                  </mat-date-range-input>
                  <mat-datepicker-toggle
                    matIconSuffix
                    [for]="picker"
                  ></mat-datepicker-toggle>
                  <mat-date-range-picker #picker></mat-date-range-picker>
                </mat-form-field>
              }
              @if (form.controls.goalsPlanned.value === 'false') {
                <mat-form-field appearance="outline" class="m-2 w-full">
                  <mat-label i18n>Begründung</mat-label>
                  <textarea
                    matInput
                    [readonly]="report().isFinalReport"
                    formControlName="noGoalsExplanation"
                    placeholder="Warum wurden keine Ziele geplant?"
                  ></textarea>
                </mat-form-field>
              }
            </div>
            <section>
              <mat-checkbox #goalstracked
                >Wirksamkeit der Strategien und Ziele werden
                nachverfolgt</mat-checkbox
              >
            </section>
            @if (goalstracked.checked) {
              <mat-form-field appearance="outline" class="m-2 w-full">
                <mat-label i18n
                  >Welche verfahren zur Nachverfolgung werden
                  genutzt?</mat-label
                >
                <textarea
                  matInput
                  [readonly]="report().isFinalReport"
                  formControlName="followUpProcedure"
                  placeholder="Welche verfahren zur Nachverfolgung werden genutzt"
                ></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="m-2 w-full">
                <mat-label i18n>Welche Zielvorgaben existieren?</mat-label>
                <textarea
                  matInput
                  [readonly]="report().isFinalReport"
                  formControlName="targets"
                  placeholder="Zielvorgaben"
                ></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="m-2 w-full">
                <mat-label i18n
                  >qualitative oder quantitative Indikatoren der
                  Fortschrittsbewertung</mat-label
                >
                <textarea
                  matInput
                  [readonly]="report().isFinalReport"
                  formControlName="progression"
                  placeholder="Indikatoren der Fortschrittsbewertung"
                ></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="m-2 w-full">
                <mat-label>Bezugszeitraum der Fortschrittsmessung</mat-label>
                <mat-date-range-input
                  [formGroup]="form.controls.referencePeriodForProgression"
                  [rangePicker]="referencePeriodForProgression"
                >
                  <input
                    matStartDate
                    formControlName="from"
                    placeholder="Start date"
                  />
                  <input
                    matEndDate
                    formControlName="to"
                    placeholder="End date"
                  />
                </mat-date-range-input>
                <mat-datepicker-toggle
                  matIconSuffix
                  [for]="referencePeriodForProgression"
                ></mat-datepicker-toggle>
                <mat-date-range-picker
                  #referencePeriodForProgression
                ></mat-date-range-picker>
              </mat-form-field>
            }
          </div>
        </div>
      </div>
    }
    @for (
      goal of form.controls.goals.controls;
      track goal;
      let pindex = $index
    ) {
      <mat-expansion-panel class="w-full !bg-neutral-200" expanded="true">
        <mat-expansion-panel-header>
          <mat-panel-title>
            Ziel {{ goal.controls.title.value }}
          </mat-panel-title>
          <mat-panel-description>
            <button
              mat-stroked-button
              (click)="removeGoal(pindex)"
              class="col-start-2 max-w-sm justify-self-end opacity-25 hover:cursor-pointer hover:opacity-100"
            >
              <mat-icon>delete</mat-icon>
              entfernen
            </button>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <div class="grid grid-cols-2">
          <app-goals
            class="col-span-2"
            (refetchEvent)="updateGoal(pindex, $event)"
            [report]="report()"
          ></app-goals>
        </div>
      </mat-expansion-panel>
    }
  </div>
  @if (!report().isFinalReport) {
    <div class="flex justify-between gap-2 pt-4">
      @if (!report().isFinalReport) {
        <button mat-flat-button (click)="addGoal()">
          <mat-icon>add</mat-icon>
          Ziel hinzufügen
        </button>
      }
      <button mat-flat-button (click)="save()" i18n [disabled]="form.invalid">
        <mat-icon>save</mat-icon>
        Speichern
      </button>
    </div>
  }
</div>
